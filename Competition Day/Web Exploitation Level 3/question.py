from flask import Flask, session, redirect, url_for, request
from random import randint, choice
from functools import reduce


app = Flask(__name__)
app.secret_key = 'hBBXdDqOzmtiBmDX9I3Rehdx4tOGpAQSDZUVxbn6'

FLAG = 'why_n0t_@ut0m@t3_1t@apuboh2018'


def generate_problem():
    n = 10
    op = ('+', '-', '*')

    gen = iter(map(str, (randint(1, 100) for _ in range(n))))
    return reduce(lambda a, n: a + choice(op) + n, gen, next(gen))


html = ('<!DOCTYPE html>'
        '<h1>You solved {} problems<h1><br>'
        'Solve this: {}'
        '<form action="/check" method=post>'
        '<input type=text name=solution>'
        '<input type=submit>'
        '</form>')


@app.route('/')
def index():
    q = session['question'] = generate_problem()
    n = session.setdefault('n', 0)

    if n < 200:
        return html.format(n, q)
    else:
        return html.format(n, FLAG)


@app.route('/check', methods=['POST'])
def check():
    try:
        q = session.get('question')
        a = request.form['solution']
        assert eval(q) == int(a)
        session['n'] += 1
    except Exception:
        session['n'] = 0
    return redirect(url_for('index'))


if __name__ == '__main__':
    app.run('0.0.0.0', 8003)
